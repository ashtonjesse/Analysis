%This scipt obtains the x and y coordinates of all pacemaker locations
%across all recordings and all experiments for baroreflex, chemoreflex and
%CCh
%It then interpolates all of these coordinates on to a specified grid 
%A binary image is created for each recording and white pixels set for each
%point
%The binary images are combined and a distance heat map is created for the
%result.

% % set files of interest
aControlFiles = {{...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro005' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro006' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro007' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro008' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro009' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro010' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro011' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro012'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro003' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro004' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro005' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro006' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro008' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro003' ...%4-9 rejected due to change in baseline rate aDistance includes baro008
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro003' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro004' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro005' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro006' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro007' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro008' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro009' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro003' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro004' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro005' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro006' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro007' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro008' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro009'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813baro003' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813baro004'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro003'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro003'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro003'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro003'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813chemo002' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814chemo001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814chemo002' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821chemo001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821chemo002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821chemo003' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826chemo001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826chemo002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826chemo003' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828chemo001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828chemo002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828chemo003' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813CCh001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813CCh002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813CCh003' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814CCh001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814CCh002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814CCh003' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814CCh004' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821CCh001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821CCh002' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826CCh001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826CCh002' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828CCh001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828CCh002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828CCh003' ...
    }};

%update origins
for p = 1:numel(aControlFiles)
    aFolder = aControlFiles{p};
    %get the location data
    [pathstr, name, ext, versn] = fileparts(char(aFolder{1}));
    [startIndex, endIndex, tokIndex, matchStr, tokenStr, exprNames, splitStr] = regexp(char(aFolder{1}), '\');
    [startIndex, endIndex, tokIndex, matchStr, tokenStr, exprNames, splitStr] = regexp(char(aFolder{1}), splitStr{end-1});
    sStimulationType = splitStr{end}(1:end-3);
    load([pathstr,'\',upper(sStimulationType(1)),sStimulationType(2:end),'LocationData.mat']);
    DPSites = repmat(struct('X1',[],'Y1',[],'X2',[],'Y2',[]),1,numel(aFolder));
    switch (sStimulationType)
        case {'baro','chemo'}
            for j = 1:numel(aFolder)
                %load the optical file
                listing = dir(aFolder{j}); %names of files vary so just get all the files in dir
                aFilesInFolder = {listing(:).name}; %convert to cell array
                aFileIndex = regexp(aFilesInFolder, [sStimulationType,'\d*a?_\w*g10_LP100Hz-waveEach.mat']); %find index of right file
                aOpticalFileName = [aFolder{j},'\',aFilesInFolder{find(~cellfun('isempty', aFileIndex))}]; %build file name
                oOptical = GetOpticalFromMATFile(Optical,char(aOpticalFileName)); %get optical file
                fprintf('Loaded %s\n', aOpticalFileName);
                
                % % %get origin data
                aOrigins = MultiLevelSubsRef(oOptical.oDAL.oHelper,oOptical.Electrodes,'aghsm','Origin');
                %loop through beats
                DPSites(j).X1 = NaN(size(aOrigins,1),1);
                DPSites(j).Y1 = NaN(size(aOrigins,1),1);
                DPSites(j).X2 = NaN(size(aOrigins,1),1);
                DPSites(j).Y2 = NaN(size(aOrigins,1),1);
                iCount = 1;
                dDistance = [NaN,NaN];
                %get the axis points
                aAxisData = cell2mat({oOptical.Electrodes(:).AxisPoint});
                oAxesElectrodes = oOptical.Electrodes(aAxisData);
                aAxesCoords = cell2mat({oAxesElectrodes(:).Coords});
                bFirstPoint = false;
                %     figure();
                %     axes();
                %     plot([aAxesCoords(1,2) aAxesCoords(1,1)],[aAxesCoords(2,2) aAxesCoords(2,1)],'k');
                %     xlim([0 10]);
                %     ylim([0 10]);
                %     hold on;
                for n = 1:size(aOrigins,1)
                    aElectrodes = oOptical.Electrodes(aOrigins(n,:));
                    if ~isempty(aElectrodes)
                        bFirstPoint = true;
                        aBeatPoints = cell2mat({aElectrodes(:).Coords});
                        for m = 1:size(aBeatPoints,2)
                            %transform coords
                            aNewBeatPoints = TransformCoordinates(aAxesCoords(:,2),aAxesCoords(:,1),aBeatPoints(:,m));
                            DPSites(j).(['X',num2str(m)])(n) = aNewBeatPoints(1);
                            DPSites(j).(['Y',num2str(m)])(n) = aNewBeatPoints(2);
                            dDistance = [aNewBeatPoints(1),aNewBeatPoints(2)];
                            %                 plot(aBeatPoints(1),aBeatPoints(2),'b+');
                            %                 plot(aNewBeatPoints(1),aNewBeatPoints(2),'r+');
                        end
                    elseif bFirstPoint
%                         DPSites(j).(['X',num2str(m)])(n) = dDistance(1);
%                         DPSites(j).(['Y',num2str(m)])(n) = dDistance(2);
                    end
                end
            end
%         case 'CCh'
%             aDistance = cell(1,numel(aFolder));
%             for j = 1:numel(aFolder)
%                 %get optical entities
%                 listing = dir(aFolder{j}); %names of files vary so just get all the files in dir
%                 aFilesInFolder = {listing(:).name}; %convert to cell array
%                 aFileIndex = regexp(aFilesInFolder, [sStimulationType,'\d*[a-z_]\w*g10_LP100Hz-waveEach.mat']); %find index of right file
%                 aOpticalFileName = {aFilesInFolder{find(~cellfun('isempty', aFileIndex),5)}}; %build file name 
%                 %loop through entities
%                 aDistance{j} = cell(1,size(aOpticalFileName,2));
%                 for q = 1:size(aOpticalFileName,2)
%                     oOptical = GetOpticalFromMATFile(Optical,[aFolder{j},'\',char(aOpticalFileName{q})]); %get optical file
%                     fprintf('Loaded %s\n', [aFolder{j},'\',aOpticalFileName{q}]);
%                     %get origin data
%                     aOrigins = MultiLevelSubsRef(oOptical.oDAL.oHelper,oOptical.Electrodes,'aghsm','Origin');
%                     % %     loop through beats
%                     aThisCoords = cell(size(aOrigins,1),1);
%                     aThisDistance = NaN(size(aOrigins,1),2);
%                     aPoints = zeros(5,2);
%                     iCount = 1;
%                     dDistance = NaN;
%                     % %     get the axis points
%                     aAxisData = cell2mat({oOptical.Electrodes(:).AxisPoint});
%                     oAxesElectrodes = oOptical.Electrodes(aAxisData);
%                     aAxesCoords = cell2mat({oAxesElectrodes(:).Coords});
%                     bFirstPoint = false;
%                     for n = 1:size(aOrigins,1)
%                         aElectrodes = oOptical.Electrodes(aOrigins(n,:));
%                         if ~isempty(aElectrodes)
%                             bFirstPoint = true;
%                             aBeatPoints = cell2mat({aElectrodes(:).Coords});
%                             aThisCoords{n} = aBeatPoints;
%                             for m = 1:size(aBeatPoints,2)
%                                 % % %                 transform coords
%                                 aNewBeatPoints = TransformCoordinates(aAxesCoords(:,2),aAxesCoords(:,1),aBeatPoints(:,m));
%                                 dDistance = aNewBeatPoints(2);
%                                 aThisDistance(n,m) = dDistance;
%                             end
%                         elseif bFirstPoint
%                             aThisDistance(n,1) = dDistance;
%                         end
%                     end
%                     if p == 17 && j == 1 && q == 1 
%                         aDistance{j}{q} = vertcat(aThisDistance(1:35,:),[NaN,NaN],[NaN,NaN],[NaN,NaN],aThisDistance(36:end,:));
%                     else
%                         aDistance{j}{q} = aThisDistance;
%                     end
%                     
%                 end
%             end
    end
    save([pathstr,'\',upper(sStimulationType(1)),sStimulationType(2:end),'LocationData_20170419.mat'],'DPSites');
    fprintf('Saved %s\n\n', [pathstr,'\',upper(sStimulationType(1)),sStimulationType(2:end),'LocationData_20170419.mat']);
end



