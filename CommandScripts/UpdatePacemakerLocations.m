%This scipt obtains the x and y coordinates of all pacemaker locations
%across all recordings and all experiments for baroreflex, chemoreflex and
%CCh and saves the result to new location data files


% % set files of interest
aControlFiles = {{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro005' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro006' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro007' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro008' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro009' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro010' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro011' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro012'...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro002' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro003' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro004' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro005' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro006' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro008' ...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro002' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro003' ...%4-9 rejected due to change in baseline rate aDistance includes baro008
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro002' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro003' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro004' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro005' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro006' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro007' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro008' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro009' ...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro002' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro003' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro004' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro005' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro006' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro007' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro008' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro009'...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813baro003' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813baro004'...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro002' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro003'...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro002' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro003'...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro002' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro003'...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro002' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro003'...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813chemo002' ...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814chemo001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814chemo002' ...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821chemo001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821chemo002' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821chemo003' ...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826chemo001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826chemo002' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826chemo003' ...
%         },{...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828chemo001' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828chemo002' ...
%         'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828chemo003' ...
%         },{...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813CCh003' ...%a&c
    },{ ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814CCh001' ... %a&c
    'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814CCh002' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814CCh004' ...
    },{...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821CCh001' ...%a+b&d
    },{ ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828CCh001' ... %b+a & c
    'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828CCh002' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828CCh003' ...
    }};

% aOnsetShiftIndexes = { ...
% {41,50,36,39,33,37,35,51}, ...
% {27,30,28,34,30,30,28}, ...
% {27,38,37}, ...
% {28,36,42,46,50,68,57,79,87}, ...
% {56,50,56,51,78,49,50,60,55}, ...
% {24,34}, ...
% {28,31,42}, ...
% {35,40,49}, ...
% {46,35,39}, ...
% {37,39,38} ...
% }; %baro onset
% aRecoveryShiftIndexes = { ...
%   {66,66,62,63,52,52,51,72}, ...  
%   {50,48,45,60,46,44,38}, ...
%   {44,51,50}, ...
%   {65,56,62,67,70,77,75,88,92}, ...
%   {60,60,75,71,84,58,74,82,76}, ...
%   {50,67}, ...
%   {58,61,66}, ...
%   {54,57,64}, ...
%   {49,40,67}, ...
%   {56,72,64}...
% }; %baro recovery
% aOnsetShiftIndexes = {{39},{33,34},{25,25,47},{29,27},{34,37,41}}; %chemo onset
% aRecoveryShiftIndexes = {{52},{60,48},{3,54,61},{37,38},{57,51,52}}; %chemo recovery
% aShiftIndexes = {{{17},{51}},{{57,77,17},{47,67,9}},{{1},{51}},{{17,2,21},{54,70,61}}}; %CCh onset

%update origins
for p = 1:numel(aControlFiles)
    aFolder = aControlFiles{p};
    %get the location data
    [pathstr, name, ext, versn] = fileparts(char(aFolder{1}));
    [startIndex, endIndex, tokIndex, matchStr, tokenStr, exprNames, splitStr] = regexp(char(aFolder{1}), '\');
    [startIndex, endIndex, tokIndex, matchStr, tokenStr, exprNames, splitStr] = regexp(char(aFolder{1}), splitStr{end-1});
    sStimulationType = splitStr{end}(1:end-3);
    %     load([pathstr,'\',upper(sStimulationType(1)),sStimulationType(2:end),'LocationData.mat']);
    DPSites = repmat(struct('X1',[],'Y1',[],'X2',[],'Y2',[],'CL1',[],'CL2',[]),1,numel(aFolder));
    switch (sStimulationType)
        case {'baro','chemo'}
            for j = 1:numel(aFolder)
                %load the optical file
                listing = dir(aFolder{j}); %names of files vary so just get all the files in dir
                aFilesInFolder = {listing(:).name}; %convert to cell array
                aFileIndex = regexp(aFilesInFolder, [sStimulationType,'\d*a?_\w*g10_LP100Hz-waveEach.mat']); %find index of right file
                aOpticalFileName = [aFolder{j},'\',aFilesInFolder{find(~cellfun('isempty', aFileIndex))}]; %build file name
                oOptical = GetOpticalFromMATFile(Optical,char(aOpticalFileName)); %get optical file
                fprintf('Loaded %s\n', aOpticalFileName);
                
                % % %get origin data
                aOrigins = MultiLevelSubsRef(oOptical.oDAL.oHelper,oOptical.Electrodes,'aghsm','Origin');
                %loop through beats
                DPSites(j).X1 = NaN(size(aOrigins,1),1);
                DPSites(j).Y1 = NaN(size(aOrigins,1),1);
                DPSites(j).X2 = NaN(size(aOrigins,1),1);
                DPSites(j).Y2 = NaN(size(aOrigins,1),1);
                iCount = 1;
                dDistance = [NaN,NaN];
                %get the axis points
                aAxisData = cell2mat({oOptical.Electrodes(:).AxisPoint});
                oAxesElectrodes = oOptical.Electrodes(aAxisData);
                aAxesCoords = cell2mat({oAxesElectrodes(:).Coords});
                bFirstPoint = false;
                %     figure();
                %     axes();
                %     plot([aAxesCoords(1,2) aAxesCoords(1,1)],[aAxesCoords(2,2) aAxesCoords(2,1)],'k');
                %     xlim([0 10]);
                %     ylim([0 10]);
                %     hold on;
                for n = 1:size(aOrigins,1)
                    aElectrodes = oOptical.Electrodes(aOrigins(n,:));
                    if ~isempty(aElectrodes)
                        bFirstPoint = true;
                        aBeatPoints = cell2mat({aElectrodes(:).Coords});
                        for m = 1:size(aBeatPoints,2)
                            %transform coords
                            aNewBeatPoints = TransformCoordinates(aAxesCoords(:,2),aAxesCoords(:,1),aBeatPoints(:,m));
                            DPSites(j).(['X',num2str(m)])(n) = aNewBeatPoints(1);
                            DPSites(j).(['Y',num2str(m)])(n) = aNewBeatPoints(2);
                            dDistance = [aNewBeatPoints(1),aNewBeatPoints(2)];
                            %                 plot(aBeatPoints(1),aBeatPoints(2),'b+');
                            %                 plot(aNewBeatPoints(1),aNewBeatPoints(2),'r+');
                        end
                    elseif bFirstPoint
%                         DPSites(j).(['X',num2str(m)])(n) = dDistance(1);
%                         DPSites(j).(['Y',num2str(m)])(n) = dDistance(2);
                    end
                end
            end
        case 'CCh'
            aDistance = cell(1,numel(aFolder));
            for j = 1:numel(aFolder)
                %get optical entities
                listing = dir(aFolder{j}); %names of files vary so just get all the files in dir
                aFilesInFolder = {listing(:).name}; %convert to cell array
                aFileIndex = regexp(aFilesInFolder, [sStimulationType,'\d*[a-z_]\w*g10_LP100Hz-waveEach.mat']); %find index of right file
                aOpticalFileName = {aFilesInFolder{find(~cellfun('isempty', aFileIndex),5)}}; %build file name 
                %loop through entities
                aDistance{j} = cell(1,size(aOpticalFileName,2));
                for q = 1:size(aOpticalFileName,2)
                    oOptical = GetOpticalFromMATFile(Optical,[aFolder{j},'\',char(aOpticalFileName{q})]); %get optical file
                    fprintf('Loaded %s\n', [aFolder{j},'\',aOpticalFileName{q}]);
                    %get origin data
                    aOrigins = MultiLevelSubsRef(oOptical.oDAL.oHelper,oOptical.Electrodes,'aghsm','Origin');
                    % %     loop through beats
                    aThisCoords = cell(size(aOrigins,1),1);
                    aThisDistance = NaN(size(aOrigins,1),2);
                    aPoints = zeros(5,2);
                    iCount = 1;
                    dDistance = NaN;
                    % %     get the axis points
                    aAxisData = cell2mat({oOptical.Electrodes(:).AxisPoint});
                    oAxesElectrodes = oOptical.Electrodes(aAxisData);
                    aAxesCoords = cell2mat({oAxesElectrodes(:).Coords});
                    bFirstPoint = false;
                    for n = 1:size(aOrigins,1)
                        aElectrodes = oOptical.Electrodes(aOrigins(n,:));
                        if ~isempty(aElectrodes)
                            bFirstPoint = true;
                            aBeatPoints = cell2mat({aElectrodes(:).Coords});
                            aThisCoords{n} = aBeatPoints;
                            for m = 1:size(aBeatPoints,2)
                                % % %                 transform coords
                                aNewBeatPoints = TransformCoordinates(aAxesCoords(:,2),aAxesCoords(:,1),aBeatPoints(:,m));
                                dDistance = aNewBeatPoints(2);
                                aThisDistance(n,m) = dDistance;
                            end
                        elseif bFirstPoint
                            aThisDistance(n,1) = dDistance;
                        end
                    end
                    if p == 17 && j == 1 && q == 1 
                        aDistance{j}{q} = vertcat(aThisDistance(1:35,:),[NaN,NaN],[NaN,NaN],[NaN,NaN],aThisDistance(36:end,:));
                    else
                        aDistance{j}{q} = aThisDistance;
                    end
                    
                end
            end
    end
    save([pathstr,'\',upper(sStimulationType(1)),sStimulationType(2:end),'LocationData_20180225.mat'],'DPSites');
    fprintf('Saved %s\n\n', [pathstr,'\',upper(sStimulationType(1)),sStimulationType(2:end),'LocationData_20180225.mat']);
end

