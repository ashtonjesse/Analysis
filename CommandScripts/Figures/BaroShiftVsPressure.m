%loop through each experiment
%load the pressure data
%load the location data
%get all beats where change in coupling interval > 100 and group into shifts
%< 1mm vs shifts > 1mm 

close all;
clear all;
aControlFiles = {{...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro005\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro006\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro007\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro008\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro009\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro010\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro011\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro012\Pressure.mat'...
    },{...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro001\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro002\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro003\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro004\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro005\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro006\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro008\Pressure.mat' ...
    },{...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro001\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro002\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro003\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro008\Pressure.mat' ...
    },{...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro001\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro002\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro003\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro004\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro005\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro006\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro007\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro008\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro009\Pressure.mat' ...
    },{...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro001\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro002\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro003\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro004\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro005\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro006\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro007\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro008\Pressure.mat' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro009\Pressure.mat'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813baro003\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813baro004\Pressure.mat'...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813baro005\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813baro006\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813baro007\Pressure.mat' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro001\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro002\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro003\Pressure.mat'...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro004\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro005\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro006\Pressure.mat' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro001\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro002\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro003\Pressure.mat'...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro004\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro005\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro006\Pressure.mat' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro001\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro002\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro003\Pressure.mat'...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro004\Pressure.mat'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro001\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro002\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro003\Pressure.mat'...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro004\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro005\Pressure.mat' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro006\Pressure.mat'...
    }};%,{
%     'G:\PhD\Experiments\Bordeaux\Data\20131129\20131129baro003\Pressure.mat'...
%     }};

dWidth = 18;
dHeight = 7;
oFigure = figure();
oColors = distinguishable_colors(numel(aControlFiles),'k');
set(oFigure,'color','white')
set(oFigure,'inverthardcopy','off')
set(oFigure,'PaperUnits','centimeters');
set(oFigure,'PaperPositionMode','manual');
set(oFigure,'Units','centimeters');
set(oFigure,'PaperSize',[dWidth dHeight],'PaperPosition',[0,0,dWidth,dHeight],'Position',[1,10,dWidth,dHeight]);
set(oFigure,'Resize','off');
oSubplotPanel = panel(oFigure);
oSubplotPanel.pack('h',3);
oSubplotPanel.de.fontsize = 10;
oSubplotPanel.de.fontweight = 'bold';
oSubplotPanel.margin = [10,15,5,8];
oSubplotPanel(1).margin = [10 0 15 0];
oSubplotPanel(2).margin = [15 0 15 0];
oSubplotPanel(3).margin = [20 0 0 0];
aCombinedShifts = cell(numel(aControlFiles),1);
for i = 1:numel(aControlFiles)
    aFiles = aControlFiles{i};
    [pathstr, name, ext, versn] = fileparts(char(aFiles{1}));
    load([pathstr(1:end-16),'\BaroLocationData.mat']);
    switch i
        case 1
            aIndices = [1,2,4,5,6,7];
        case 2
            aIndices = [1,2,3,4,5,6,7];
        case 3
            aIndices = [1,2,3];
        case 4
            aIndices = [1,2,3,4,5,6,7,8];
        case 5
            aIndices = [2,3,4,5,6,7,8,9];
    end
    AllPressures = cell(numel(aIndices),1);
    AllShifts = cell(numel(aIndices),1);
    MeanPressures = cell(numel(aIndices),1);
    MaxShifts = cell(numel(aIndices),1);
    for m = 1:numel(aIndices)
        j = aIndices(m);
        oPressure = GetPressureFromMATFile(Pressure,char(aFiles{j}),'Optical');
        fprintf('Got file %s\n',char(aFiles{j}));
        switch (i)
            case {7,10}
                if j == 1
                    iRecordingIndex = 2;
                else
                    iRecordingIndex = 1;
                end
                aCouplingIntervals  = 60000 ./ [NaN oPressure.oRecording(iRecordingIndex).Electrodes.Processed.BeatRates];
                aTimes = oPressure.oRecording(iRecordingIndex).Electrodes.Processed.BeatRateTimes;
            case 8
                if j == 1 || j == 2
                    iRecordingIndex = 2;
                else
                    iRecordingIndex = 1;
                end
                aCouplingIntervals  = 60000 ./ [NaN oPressure.oRecording(iRecordingIndex).Electrodes.Processed.BeatRates];
                aTimes = oPressure.oRecording(iRecordingIndex).Electrodes.Processed.BeatRateTimes;
            case 9
                aCouplingIntervals = 60000 ./ oPressure.oRecording(1).Electrodes.Processed.BeatRates';
                aTimes = [oPressure.oRecording(1).TimeSeries(...
                    oPressure.oRecording(1).Electrodes.Processed.BeatRateIndexes(1:end-1)) NaN];
            case 11                
                aCouplingIntervals = 60000 ./ oPressure.oRecording(1).Electrodes.Processed.BeatRates';
                aTimes = oPressure.oRecording.TimeSeries(oPressure.oRecording(1).Electrodes.Processed.BeatRateIndexes);
            otherwise
                aCouplingIntervals  = 60000 ./ [NaN oPressure.oRecording(1).Electrodes.Processed.BeatRates];
                aTimes = oPressure.oRecording(1).Electrodes.Processed.BeatRateTimes;
        end
        aTimePoints = aTimes > oPressure.TimeSeries.Original(oPressure.HeartRate.Plateau.Range(1)) & ...
            aTimes < oPressure.TimeSeries.Original(oPressure.HeartRate.Plateau.Range(2));
        aPressureProcessedData = oPressure.FilterData(oPressure.Original.Data, 'LowPass', oPressure.oExperiment.PerfusionPressure.SamplingRate, 1);
        aPressures = zeros(1,numel(aTimes));
        for n = 1:numel(aTimes)
            %         find the index that is closest to this time
            [MinVal MinIndex] = min(abs(oPressure.TimeSeries.Original - aTimes(n)));
            aPressures(n) = aPressureProcessedData(MinIndex);
        end
        aPressures = aPressures(aTimePoints)';
        aLocs =  aDistance{j}(:,1);
        if size(aLocs,1) ~= numel(aCouplingIntervals);
            if i == 4
                switch (j)
                    case 9
                        aLocs = vertcat(aLocs(1:49),aLocs(49),aLocs(50:end));
                    case 8
                        aLocs = vertcat(aLocs(1:20),aLocs(20),aLocs(21:end));
                    case 6
                        aLocs = vertcat(aLocs(1:22),aLocs(22),aLocs(23:end));
                    case 7
                        aLocs = vertcat(aLocs(1:18),aLocs(18),aLocs(19:end));
                end
            else 
                disp('broken');
                break; 
            end
        end
        aShifts = aLocs(aTimePoints);
        AllPressures{m} = aPressures;
        AllShifts{m} = aShifts;
        MeanPressures{m} = mean(aPressures);
        MaxShifts{m} = max(aShifts);
    end
    oFirstAxes = oSubplotPanel(1).select();
    StackedPressures = vertcat(AllPressures{:});
    StackedShifts = vertcat(AllShifts{:});
    aCombinedShifts{i} = StackedShifts;
    scatter(oFirstAxes,StackedPressures,StackedShifts,16,oColors(i,:),'filled','displayname',pathstr(end-23:end-16));
    hold(oFirstAxes,'on');
    X = [ones(length(StackedPressures),1) StackedPressures];
    b = X\StackedShifts;
    yCalc = X*b;
    Rsq = 1 - sum((StackedShifts - yCalc).^2)/sum((StackedShifts - mean(StackedShifts)).^2);
    oLine = plot(oFirstAxes,StackedPressures,yCalc,'-','color',oColors(i,:));
    set(get(get(oLine,'Annotation'),'LegendInformation'),'IconDisplayStyle','off');
    text(max(StackedPressures),max(yCalc),sprintf('%4.2f',Rsq),'color',oColors(i,:),'parent',oFirstAxes);
    
    oSecondAxes = oSubplotPanel(2).select();
    StackedPressures = vertcat(MeanPressures{:});
    StackedShifts = vertcat(MaxShifts{:});
    scatter(oSecondAxes,StackedPressures,StackedShifts,16,oColors(i,:),'filled','displayname',pathstr(end-23:end-16));
    hold(oSecondAxes,'on');
    X = [ones(length(StackedPressures),1) StackedPressures];
    b = X\StackedShifts;
    yCalc = X*b;
    Rsq = 1 - sum((StackedShifts - yCalc).^2)/sum((StackedShifts - mean(StackedShifts)).^2);
    oLine = plot(oSecondAxes,StackedPressures,yCalc,'-','color',oColors(i,:));
    set(get(get(oLine,'Annotation'),'LegendInformation'),'IconDisplayStyle','off');
    text(max(StackedPressures),max(yCalc),sprintf('%4.2f',Rsq),'color',oColors(i,:),'parent',oSecondAxes);
    
end
hold(oFirstAxes,'off');
hold(oSecondAxes,'off');
set(oFirstAxes,'ydir','reverse');
% legend(oFirstAxes,'show');
set(get(oFirstAxes,'xlabel'),'string','Perfusion pressure (mmHg)');
set(get(oFirstAxes,'ylabel'),'string','Shift (mm)');
set(oSecondAxes,'ydir','reverse');
oLegend = legend(oSecondAxes,'show');
set(oLegend,'fontsize',8,'fontweight','normal','position',[0.511 0.644 0.115 0.258],'box','off','color','none');
set(get(oSecondAxes,'xlabel'),'string','Mean perfusion pressure (mmHg)');
set(get(oSecondAxes,'ylabel'),'string','Max Shift (mm)');
ylim = [0 7];
xlim = [85 155];
set(oFirstAxes,'xlim',xlim);
set(oFirstAxes,'ylim',ylim);
[figx figy] = dsxy2figxy(oFirstAxes, [xlim(1)+5 xlim(1)+5], [ylim(2) ylim(2)]);
annotation('textbox',[figx(1) figy(1) 0.1 0.1],'string','A',...
    'edgecolor','none','fontsize',16,'fontweight','bold','margin',0);

set(oSecondAxes,'xlim',xlim);
set(oSecondAxes,'ylim',ylim);
[figx figy] = dsxy2figxy(oSecondAxes, [xlim(1)+5 xlim(1)+5], [ylim(2) ylim(2)]);
annotation('textbox',[figx(1) figy(1) 0.1 0.1],'string','B',...
    'edgecolor','none','fontsize',16,'fontweight','bold','margin',0);

%plot histogram
oSubplotPanel(3).pack('v',{0.25 0.75});
oThirdAxes = oSubplotPanel(3,2).select();
StackedShifts = vertcat(aCombinedShifts{:});
hist(oThirdAxes,StackedShifts,0:0.5:7);
axis(oThirdAxes,'tight');
set(get(oThirdAxes,'title'),'string','Distribution of shift locations');
set(get(oThirdAxes,'title'),'fontweight','bold');
set(get(oThirdAxes,'xlabel'),'string','Shift location (mm)');
set(get(oThirdAxes,'ylabel'),'string','Frequency');
annotation('textbox',[figx(1)+0.3 figy(1) 0.1 0.1],'string','C',...
    'edgecolor','none','fontsize',16,'fontweight','bold','margin',0);