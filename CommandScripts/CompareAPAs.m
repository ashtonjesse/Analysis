%this script compares the average action potential amplitude for 5 baseline
%beats vs the beats preceding the shift in the central node DP
%site

%get average APA for first 5 beats 
aControlFiles = {{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro005' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140703\20140703baro006' ...
%      },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140715\20140715baro002' ...
%     },{...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro001' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140718\20140718baro002' ...
    },{...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro001' ...
    'G:\PhD\Experiments\Auckland\InSituPrep\20140722\20140722baro002' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro003' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140723\20140723baro004' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813baro003' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813baro004'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814baro003'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821baro003'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826baro003'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828baro003'...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813chemo002' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814chemo001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814chemo002' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821chemo001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821chemo002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821chemo003' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826chemo001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826chemo002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826chemo003' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828chemo001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828chemo002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828chemo003' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813CCh001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813CCh002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140813\20140813CCh003' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814CCh001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814CCh002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814CCh003' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140814\20140814CCh004' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821CCh001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140821\20140821CCh002' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826CCh001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140826\20140826CCh002' ...
%     },{...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828CCh001' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828CCh002' ...
%     'G:\PhD\Experiments\Auckland\InSituPrep\20140828\20140828CCh003' ...
    }};
%create figures
try 
    close(oFigure);
catch ex
    
end
oFigure = figure();
oAxes = axes('parent',oFigure);
%get the APAs
%initiate variables
aAPAData = cell(numel(aControlFiles),1);
dRadius = 1.5;
aShiftIndexes = {{27,38},{28,36}};
for p = 1:numel(aControlFiles)
    aFolder = aControlFiles{p};
    aAPAData{p} = cell(1,numel(aFolder));
    [pathstr, name, ext, versn] = fileparts(char(aFolder{1}));
    [startIndex, endIndex, tokIndex, matchStr, tokenStr, exprNames, splitStr] = regexp(char(aFolder{1}), '\');
    [startIndex, endIndex, tokIndex, matchStr, tokenStr, exprNames, splitStr] = regexp(char(aFolder{1}), splitStr{end-1});
    sStimulationType = splitStr{end}(1:end-3);
    switch (sStimulationType)
        case {'baro','chemo'}
            for j = 1:numel(aFolder)
                %load the optical file
                listing = dir(aFolder{j}); %names of files vary so just get all the files in dir
                aFilesInFolder = {listing(:).name}; %convert to cell array
                aFileIndex = regexp(aFilesInFolder, [sStimulationType,'\d*a?_\w*g10_LP100Hz-waveEach.mat']); %find index of right file
                aOpticalFileName = [aFolder{j},'\',aFilesInFolder{find(~cellfun('isempty', aFileIndex))}]; %build file name
                oOptical = GetOpticalFromMATFile(Optical,char(aOpticalFileName)); %get optical file
                fprintf('Loaded %s\n', aOpticalFileName);
                %                 %load the pressure file
                %                 aFileIndex = regexp(aFilesInFolder, 'Pressure.mat'); %find index of right file
                %                 sPressureFileName = [aFolder{j},'\',aFilesInFolder{find(~cellfun('isempty', aFileIndex))}]; %build file name
                %                 oPressure = GetPressureFromMATFile(Pressure,char(sPressureFileName),'Optical');
                %                 fprintf('Loaded %s\n', sPressureFileName);
                %                 %get the beats that lead up to the shift
                %                 aTimes = oPressure.oRecording(1).Electrodes.Processed.BeatRateTimes;
                %                 aBeats = aTimes > oPressure.TimeSeries.Original(oPressure.HeartRate.Decrease.Range(1)) & ...
                %                     aTimes < oPressure.TimeSeries.Original(oPressure.HeartRate.Decrease.Range(2));
                
                aBeats = false(size(oOptical.Beats.Indexes,1),1);
                aBeats(aShiftIndexes{p}{j}-10:aShiftIndexes{p}{j}-1) = true;
                aBeatIndexes = find(aBeats);
                %load activation data
                aActivationData = oOptical.PrepareActivationMap(100, 'Contour', 'arsps', 24, aBeatIndexes(1), [], []);
                for m = 2:length(aBeatIndexes)
                    aActivationData = oOptical.PrepareActivationMap(100, 'Contour', 'arsps', 24, aBeatIndexes(m), aActivationData, []);
                end
                disp('Collected activation data');
                %get central electrode by averaging the DP site for the first five beats
                aOriginData = MultiLevelSubsRef(oOptical.oDAL.oHelper,...
                    oOptical.Electrodes,'aghsm','Origin');
                aAvCoords = mean(cell2mat({oOptical.Electrodes(logical(sum(aOriginData(1:6,:),1))).Coords}),2);
                %get electrodes within neighbourhood
                aElectrodes = oOptical.GetElectrodesWithinRadius(aAvCoords', dRadius);
                if isfield(oOptical.Electrodes(1).arsps,'Map')
                    aAcceptedChannels = MultiLevelSubsRef(oOptical.oDAL.oHelper,oOptical.Electrodes,'arsps','Map');
                    aAcceptedChannels = aAcceptedChannels(aBeatIndexes(1),:);
                else
                    aAcceptedChannels = MultiLevelSubsRef(oOptical.oDAL.oHelper,oOptical.Electrodes,'Accepted');
                end
                aElectrodes = aElectrodes(logical(aAcceptedChannels));
                %select average APA for these electrodes
                aAPA =  cell2mat({aActivationData.Beats(aBeats).APAData});
                aAPAData{p}{j} = mean(aAPA(aElectrodes,:),1);
                plot(oAxes,aAPAData{p}{j},'k-');
                hold(oAxes,'on');
            end
    end
end


% fprintf('%4.0f,%3.0f,%5.3f,%5.3f\n',iElectrode,iBeat,oActivation.AverageAPA(iElectrode),oActivation.Beats(iBeat).APAData(iElectrode)+oActivation.AverageAPA(iElectrode));